## Правила шарової архітектури

**Назва**: Впровадження модульного моноліту і шарової архітектури

**Статус**: Прийнято

**Дата**: 15.11.2025

## Контекст
Наш проєкт використовує модульний моноліт на базі Laravel. Для забезпечення чистоти, тестування та масштабованості коду ми впроваджуємо тришарову архітектуру за принципами DDD (Domain-Driven Design). Кожен Bounded Context (Account, Transaction і т.д) використовує цю структуру.

## Шари та їх відповідальність
**Доменний шар (domain/)**

- Зберігається: доменні сутності
- Відповідальність: зберігання стану, захист інваріантів (бізнес-правил)
- Приклад: Account.php (з методом withdraw()), Transaction.php (з інваріантом на суму)

**Сервісний шар (service/)**

- Зберігається: use case класи; репозиторії
- Відповідальність: **use case класи -** координація бізнес-процесів, керування транзакціями (ACID), мапінг DTO ↔ Domain; **репозиторії -** конкретна реалізація CRUD, робота з Eloquent (наприклад, AccountRepository.php).
- Приклад: TransactionService.php (метод store), AccountService.php

**API/Контролерний Шар (api/)**

- Зберігається: контролери, DTO
- Відповідальність: **контролери -** обробка HTTP-запитів, валідація вхідних DTO, виклик Service Layer, формування JSON-відповіді та HTTP-статусу; **DTO -** об'єкти для обміну даними (вхід/вихід)
- Приклад: AccountApiController.php, HealthController.php; AccountRequestDto.php, AccountResponseDto.php

## Правила Залежностей

Залежності завжди повинні йти з зовнішніх шарів до внутрішніх. Це створює "односторонній потік" і захищає доменний шар від змін у зовнішньому інтерфейсі.

**API Layer** ⮕ **Service Layer** ⮕ **Domain Layer/Repositories**

**Прийнятно:** контролер викликає сервіс; сервіс викликає репозиторій

**Неприйнятно:** клас у domain/ імпортує або викликає клас із api/ (наприклад, Account не може знати про AccountApiController)

## Заборонені зв'язки

- **Заборона крос-шарового доступу до БД:** API Layer не має права напряму звертатися до БД або до репозиторію.

- **Заборона розкриття Domain/Persistence:** Service Layer повинен перетворювати Domain Models (Eloquent) на DTO перед поверненням результату в API Layer.

- **Ізоляція технологій:** Domain Layer не повинен містити жодних посилань на фреймворки чи ORM (хоча в нашому моноліті він успадковує Eloquent\Model, це компроміс, який ми прийняли для спрощення).